---
title: "Starting_raw_data_only"
author: "Carrie"
date: "2024-11-13"
output: html_document
---

```{r}
library(readr)
library(readxl)
library(here)
library(tidyverse)
```

# New eo_md 

990 or not is PF filing req code
filing req code - don't have to file any forms or not 01 = 990, 02 = 990 but less than 25000 income, 03 = group return (don't know what that means), 06 = church, 07 = gov, 00 = not required to file
 
 direct link: https://www.irs.gov/pub/irs-soi/eo_md.csv
```{r}
irs_new<- read_csv("New_version_data/eo_md_downloaded_Aug22.csv") # direct link https://www.irs.gov/pub/irs-soi/eo_md.csv
```
# new epostcard

link: https://www.irs.gov/charities-non-profits/tax-exempt-organization-search-bulk-data-downloads
direct link to data: https://apps.irs.gov/pub/epostcard/data-download-epostcard.zip (last data posting Jan 2024)
dictionary: https://www.irs.gov/pub/irs-tege/990n-data-dictionary.pdf

EIN, Tax Year , Organization Name, Gross receipts not greater than, Organization has terminated, Tax Period Begin Date , Tax Period End Date , Website URL , Principal Officer’s Name , Principal Officer’s Address Line 1, Principal Officer’s Address Line 2, Principal Officer’s Address City , Principal Officer’s Address Province, Principal Officer’s Address State , Principal Officer’s Address Zip Code , Principal Officer’s Address Country ,Organization Mailing Address Line 1 , Organization Mailing Address Line 2 , Organization Mailing Address City , Organization Mailing Address Province , Organization Mailing Address State , Organization Mailing Address Zip Code, Organization Mailing Address Country ,Organization Doing Business as Name 1, Organization Doing Business as Name 2 , Organization Doing Business as Name 3 ,
```{r}
# specify character for last column
epost <- read_delim("New_version_data/data-download-epostcard_2024.txt", 
    delim = "|", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE, col_types = c("X26" = "c"))
```

check problems
```{r}
pepost<-problems(epost)
count(pepost, col)


colnames(epost) <- c("EIN", "Tax Year" , "Organization Name", "Gross receipts not greater than", "Organization has terminated", "Tax Period Begin Date" , "Tax Period End Date" , "Website URL" , "Principal Officer’s Name" , "Principal Officer’s Address Line 1", "Principal Officer’s Address Line 2", "Principal Officer’s Address City" , "Principal Officer’s Address Province", "Principal Officer’s Address State" , "Principal Officer’s Address Zip Code" , "Principal Officer’s Address Country" ,"Organization Mailing Address Line 1" , "Organization Mailing Address Line 2" , "Organization Mailing Address City" , "Organization Mailing Address Province" , "Organization Mailing Address State" , "Organization Mailing Address Zip Code", "Organization Mailing Address Country" ,"Organization Doing Business as Name 1", "Organization Doing Business as Name 2", "Organization Doing Business as Name 3")

library(janitor)

epost <-clean_names(epost)

```
Get problematic rows:

```{r}
epost %>% slice(pepost$row[1]: last(pepost$row)) %>% glimpse()# looking at first problematic row # URL is not a url
epost_prob_rows<-epost %>% slice(pepost$row)

```

Check if problematic rows matter to us

```{r}
#check for rows with MD in any column
unlist(sapply(epost_prob_rows, grep, pattern = "MD"))
# looks ok!
```


## IRS Publication 78 data

publication 78: https://apps.irs.gov/pub/epostcard/data-download-pub78.zip (direct link)

colnames from: https://nccsgit.urban.org/nccs/datasets/pub78/#:~:text=Publication%2078%20is%20an%20example,to%20receive%20tax%2Ddeductible%20donations.

Question: should we do anything with the deductible codes
```{r}
pub78 <-  read_delim("New_version_data/data-download-pub78_2024.txt", 
    delim = "|", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE)

colnames(pub78) <-c("EIN", "legal_name",	"city",	"state",	"country",	"deductibility_status")
```

limitations of pub 78: https://nccsgit.urban.org/nccs/datasets/pub78/#:~:text=Publication%2078%20is%20an%20example,to%20receive%20tax%2Ddeductible%20donations.

PC:	A public charity.	50% (60% for cash contributions)
POF:	A private operating foundation.	50% (60% for cash contributions)
PF:	A private foundation.	30% (generally)
GROUP	Generally, a central organization holding a group exemption letter, whose subordinate units covered by the group exemption are also eligible to receive tax-deductible contributions, even though they are not separately listed.	Depends on various factors
LODGE:	A domestic fraternal society, operating under the lodge system, but only if the contribution is to be used exclusively for charitable purposes.	30%
UNKWN	A charitable organization whose public charity status has not been determined.	Depends on various factors
EO:	An organization described in section 170(c) of the Internal Revenue Code other than a public charity or private foundation.	Depends on various factors
FORGN	A foreign-addressed organization. These are generally organizations formed in the United States that conduct activities in foreign countries. Certain foreign organizations that receive charitable contributions deductible pursuant to treaty are also included, as are organizations created in U.S. possessions.	Depends on various factors
SO:	A Type I, Type II, or functionally integrated Type III supporting organization.	50% (60% for cash contributions)
SONFI:	A non-functionally integrated Type III supporting organization.	50% (60% for cash contributions)
SOUNK:	A supporting organization, unspecified type.	50% (60% for cash contributions)

Combine IRS data 
```{r}
irs_new<- rename_with(irs_new, tolower)

IRS <-left_join(irs_new, pub78, by = c("ein" = "EIN"), suffix = c("_eo", "_pub78")) # keeps all rows of irs_new and adds info from pub78 where possible as new columns- NA is given for rows not in pub78


IRS <-left_join(IRS, epost, by = "ein") # keeps all rows of IRS and adds info from epost where possible as new columns

IRS %>% count(tax_year) %>% print( 20)
```



## Revocations

direct link: https://apps.irs.gov/pub/epostcard/data-download-revocation.zip 

Found here: https://www.irs.gov/charities-non-profits/tax-exempt-organization-search-bulk-data-downloads in the Automatic revocation of exemption list section under the bullet: Automatic revocation of exemption list 


```{r}
revocations <- read_delim("New_version_data/data-download-revocation.txt",
    delim = "|", escape_double = FALSE, col_names = FALSE,
    trim_ws = TRUE)

IRS_no_revoc<-anti_join(IRS, revocations, by = c("ein" = "X1")) # Removing those in the revocation list based on the EIN
nrow(IRS) - nrow(IRS_no_revoc) # removes 3157
dim(IRS_no_revoc)
IRS<- IRS_no_revoc
```

## PO Boxes

```{r}
#check PO box stuff: IRS %>% filter(str_detect(street, "PO ")) %>% pull(street)
nrow(IRS)
IRS <- IRS %>% filter(!str_detect(street, "PO "))
nrow(IRS) # removed ~5000

```


<!-- ## Filter by year -->
<!-- Let's make the new data match the paper statement:  -->
<!-- ```{r} -->
<!-- filter(irs_new, year == 2020) %>% count(year, month) # looks like all 2020 data is after Jan -->
<!-- irs_new_2020<- filter(IRS, tax_year  <= 2020 |is.na(tax_year)) # keep rows where year is less than or equal to 2020 or is na -->

<!-- #Check for jan data from 2020 -->
<!-- filter(irs_new_2020, year == 2020, month ==1) -->

<!-- #irs_old_2020 <- filter(irs_old, year <2020) # this removes NAs -->
<!-- year_info <-IRS %>% dplyr::select(contains(c("year","period")))  -->

<!-- print(filter(year_info, rowSums(is.na(year_info)) != ncol(year_info))) # hmm where are there many with no date info... -->

<!-- # what ar the rows with all NA??? -->
<!-- IRS %>% filter(is.na(year)) -->
<!-- ``` -->



Save the data:
```{r}
#write_rds(IRS, file = "New_version_data/new_IRSdata.rds")
```




